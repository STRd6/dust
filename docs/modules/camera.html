<!DOCTYPE html>

<html>
<head>
  <title>modules/camera</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, target-densitydpi=160dpi, initial-scale=1.0; maximum-scale=1.0; user-scalable=0;">
  <link rel="stylesheet" media="all" href="http://strd6.github.io/cdn/parallel/docco.css" />
</head>
<body>
  <div id="container">
    <div id="background"></div>
    <ul class="sections">
        
        
        <li id="section-1">
            <div class="annotation">
              <div class="pilwrap">
                <a class="pilcrow" href="#section-1">&#182;</a>
              </div>
              <h1 id="camera">Camera</h1>

            </div>
            <div class="content"><pre><code class="lang-coffeescript">
</code></pre>
</div>
        </li>
        
        
        <li id="section-2">
            <div class="annotation">
              <div class="pilwrap">
                <a class="pilcrow" href="#section-2">&#182;</a>
              </div>
              
            </div>
            <div class="content"><pre><code class="lang-coffeescript">Bindable = require <span class="string">"./bindable"</span>
{defaults} = require <span class="string">"../util"</span>

<span class="function"><span class="title">Camera</span></span> = (I={}, self=Bindable(I)) -&gt;

  defaults I,
    screen: <span class="comment"># Screen Coordinates</span>
      x: <span class="number">0</span>
      y: <span class="number">0</span>
      width: <span class="number">1024</span>
      height: <span class="number">576</span>
    deadzone: Point(<span class="number">0</span>, <span class="number">0</span>) <span class="comment"># Screen Coordinates</span>
    zoom: <span class="number">1</span>
    transform: Matrix()
    velocity: Point.ZERO
    maxSpeed: <span class="number">750</span>
    t90: <span class="number">2</span> <span class="comment"># Time in seconds for camera to move 90% of the way to the target</span>

  <span class="comment"># World Coordinates</span>
  I.x ?= I.screen.width/<span class="number">2</span>
  I.y ?= I.screen.height/<span class="number">2</span>

  I.cameraBounds ?= I.screen

  currentType = <span class="string">"centered"</span>
  currentObject = <span class="literal">null</span>

  objectFilters = []
  transformFilters = []

  <span class="function"><span class="title">focusOn</span></span> = (object, elapsedTime) -&gt;
    dampingFactor = <span class="number">2</span>

    <span class="comment">#TODO: Different t90 value inside deadzone?</span>

    c = elapsedTime * <span class="number">3.75</span> / I.t90
    <span class="keyword">if</span> c &gt;= <span class="number">1</span>
      <span class="comment"># Spring is configured to be too intense, just snap to target</span>
      self.position(target)
      I.velocity = Point.ZERO
    <span class="keyword">else</span>
      objectCenter = object.center()

      target = objectCenter

      delta = target.subtract(self.position())

      force = delta.subtract(I.velocity.scale(dampingFactor))
      self.changePosition(I.velocity.scale(c).clamp(I.maxSpeed))
      I.velocity = I.velocity.add(force.scale(c))

  followTypes =
    centered: (object, elapsedTime) -&gt;
      I.deadzone = Point(<span class="number">0</span>, <span class="number">0</span>)

      focusOn(object, elapsedTime)

    topdown: (object, elapsedTime) -&gt;
      helper = Math.max(I.screen.width, I.screen.height) / <span class="number">4</span>

      I.deadzone = Point(helper, helper)

      focusOn(object, elapsedTime)

    platformer: (object, elapsedTime) -&gt;
      width = I.screen.width / <span class="number">8</span>
      height = I.screen.height / <span class="number">3</span>

      I.deadzone = Point(width, height)

      focusOn(object, elapsedTime)

  self.extend
    follow: (object, type=<span class="string">"centered"</span>) -&gt;
      currentObject = object
      currentType = type

    objectFilterChain: (fn) -&gt;
      objectFilters.push fn

    transformFilterChain: (fn) -&gt;
      transformFilters.push fn

    screenToWorld: (point) -&gt;
      self.transform().inverse().transformPoint(point)

  self.attrAccessor <span class="string">"transform"</span>

  self.<span class="literal">on</span> <span class="string">"afterUpdate"</span>, (elapsedTime) -&gt;
    <span class="keyword">if</span> currentObject
      followTypes[currentType](currentObject, elapsedTime)

    <span class="comment"># Hard clamp camera to world bounds</span>
    I.x = I.x.clamp(I.cameraBounds.left + I.screen.width<span class="regexp">/2, I.cameraBounds.right - I.screen.width/</span><span class="number">2</span>)
    I.y = I.y.clamp(I.cameraBounds.top + I.screen.height<span class="regexp">/2, I.cameraBounds.bottom - I.screen.height/</span><span class="number">2</span>)

    I.transform = Matrix.translate(I.screen.width<span class="regexp">/2 - I.x.floor(), I.screen.height/</span><span class="number">2</span> - I.y.floor())

  self.<span class="literal">on</span> <span class="string">"draw"</span>, (canvas, objects) -&gt;
    <span class="comment"># Move to correct screen coordinates</span>
    canvas.withTransform Matrix.translate(I.screen.x, I.screen.y), (canvas) -&gt;
      canvas.clip(<span class="number">0</span>, <span class="number">0</span>, I.screen.width, I.screen.height)

      objects = objectFilters.pipeline(objects)
      transform = transformFilters.pipeline(self.transform().copy())

      canvas.withTransform transform, (canvas) -&gt;
        self.trigger <span class="string">"beforeDraw"</span>, canvas
        objects.invoke <span class="string">"draw"</span>, canvas

      self.trigger <span class="string">'flash'</span>, canvas

  self.<span class="literal">on</span> <span class="string">"overlay"</span>, (canvas, objects) -&gt;
    canvas.withTransform Matrix.translate(I.screen.x, I.screen.y), (canvas) -&gt;
      canvas.clip(<span class="number">0</span>, <span class="number">0</span>, I.screen.width, I.screen.height)
      objects = objectFilters.pipeline(objects)

      objects.invoke <span class="string">"trigger"</span>, <span class="string">"overlay"</span>, canvas

  self.include require <span class="string">"./age"</span>
  self.include require <span class="string">"./bounded"</span>

  <span class="comment"># The order of theses includes is important for</span>
  <span class="comment"># the way in wich they modify the camera view transform</span>

  <span class="keyword">for</span> module <span class="keyword">in</span> Camera.defaultModules
    self.include module

  <span class="keyword">return</span> self

Camera.defaultModules = [
  <span class="string">"z_sort"</span>
].map (name) -&gt;
  require <span class="string">"./camera/<span class="subst">#{name}</span>"</span></code></pre>
</div>
        </li>
        
        
        <li id="section-3">
            <div class="annotation">
              <div class="pilwrap">
                <a class="pilcrow" href="#section-3">&#182;</a>
              </div>
              <h1 id="todo-include-these-camera-modules">TODO: Include these camera modules</h1>
<p>&quot;Zoom&quot;
&quot;Rotate&quot;
&quot;Shake&quot;
&quot;Flash&quot;
&quot;Fade&quot;
&quot;Transition&quot;</p>

            </div>
            <div class="content"><pre><code class="lang-coffeescript">module.exports = Camera</code></pre>
</div>
        </li>
        
    </ul>
  </div>
  <script src="//code.jquery.com/jquery-1.10.1.min.js"></script>
<script src="//cdnjs.cloudflare.com/ajax/libs/coffee-script/1.6.3/coffee-script.min.js"></script>
<script src="http://strd6.github.io/require/v0.2.2.js"></script>
<script src="https://code.jquery.com/jquery-1.10.1.min.js"></script><script>
  $.ajax({
    url: "http://strd6.github.io/interactive/v0.8.1.jsonp",
    dataType: "jsonp",
    jsonpCallback: "STRd6/interactive:v0.8.1",
    cache: true
  }).then(function(PACKAGE) {
    Require.generateFor(PACKAGE)("./" + PACKAGE.entryPoint)
  })
</script><script src="../package.js"></script>
</body>
</html>